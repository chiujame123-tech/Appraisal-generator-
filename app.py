import streamlit as st
import re

# ==========================================
# 1. 建立 FS-278 評分指標資料庫 (升級版：支援多種寫法)
# ==========================================
# 結構： "項目": { "評級": [ { "desc": "款式名稱", "行動": "...", "局內": "..." }, ... ] }
fs278_db = {
    "1. 工作認識": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "極之熟悉分區內的各特別風險及其緊急應變計劃，對分局內各樓宇的消防設施及裝置極之熟悉，對所有滅火拯救工具的運用都瞭如指掌，並了解現時先進的滅火常識及未來消防工程的發展。", "局內": "熟讀部門的各項公文，包括常務訓令及各消防事務手冊。對部門的新發展非常熟悉，並精通各項行政與工作程序。"},
            {"desc": "寫法二 (強調實戰)", "行動": "實戰經驗極為豐富，對各種消防車輛及拯救工具的使用方法極為熟識，對分局內的特別風險及樓宇消防設施瞭如指掌，展現出極深厚的專業知識。", "局內": "對局內各項公文及新發展瞭如指掌，並能精準無誤地處理各項繁瑣的行政與工作程序。"}
        ],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "十分熟知分局內的各特別風險及其緊急應變計劃，對各樓宇的消防設施有充分了解，對局內各種拯救工具十分熟悉。", "局內": "對部門的各項公文有深厚的認識，十分熟悉各項行政工作程序，並密切留意部門的新發展。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "認識分局內的各特別風險及其緊急應變計劃，對局內各種滅火拯救工具有一定的認識。", "局內": "對部門的各項公文有一定的認識，對個別行政程序有基本了解。"}]
    },
    "2. 行動效率/專業能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "在無需監督下，能非常迅速、有效地完成工作，處事能作多方面思考並常常給予上級多個可行建議，充分顧及團隊及公眾安全。", "局內": "在各種操練中表現傑出，能即時糾正其他隊員的錯誤，更能建議上級各種不同操練的形式與情景。"},
            {"desc": "寫法二 (思維敏捷)", "行動": "工作效率極高，能在無需監督的情況下迅速妥善完成任務。處事靈活且作多方面思考，經常為上級提供具建設性的建議，同時高度重視自身及團隊安全。", "局內": "於各項操練中表現卓越，不單能即時指導隊員糾正錯誤，更能主動構思並建議不同形式的模擬操練以提升團隊效率。"}
        ],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "在無需監督下，能迅速有效地完成工作，經常能給予上級確切可行的建議。", "局內": "在各種操練中表現良好，能對基本操練提出改善建議。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "在有限的監督下，能迅速有效地完成工作，偶而給予上級建議。", "局內": "在基本操練中表現良好。"}]
    },
    "3. 承擔責任": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "極之積極接受各類型工作，如主動尋找火源及調查成因。", "局內": "極之積極承擔局內工作，除了管理得井井有條外，更能作出改善建議。"},
            {"desc": "寫法二 (勇於擔當)", "行動": "極願意承擔額外責任，無論面對任何艱巨任務皆極之積極應對，如主動深入現場尋找火源。", "局內": "對局內大小事務皆極具責任感，積極承擔各項文書及管理工作，並不斷提出完善機制的建議。"}
        ],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "積極接受各類型工作。", "局內": "積極承擔局內各項工作並管理得當。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "接受並妥善完成簡單的行動工作。", "局內": "在上級委派下承擔局內工作並管理得當。"}]
    },
    "4. 可靠程度": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "多次工作皆能非常準確無誤地在指定時間內完成，並定期作出滙報，深得各級同事信賴。"},
            {"desc": "寫法二 (值得信賴)", "通用": "是一名極之可靠的副手，凡事皆能準確無誤地在時限內妥善完成，並會適時滙報進度，深得上級及同事的信任。"}
        ],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "每項工作皆能準確無誤地完成，並定期作出滙報，深得上級認同。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "每項工作皆能完成並定期滙報。"}]
    },
    "5. 領導才能": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "能夠協助現場總指揮，恰當地分配工作，調派及帶領各分隊有效地執行任務，並全面照顧隊員安全。", "局內": "能夠帶領局內各類型的操練，即時糾正同事錯誤，並主動協助分隊主管妥善管理局內大小事務。"},
            {"desc": "寫法二 (指揮若定)", "行動": "運用出色的組織能力為隊員制定行動方向，往往能表現出極佳的領導才能，於現場能恰當分配工作並全面保障屬員安全。", "局內": "具備優秀的領導潛質，經常主動帶領及指導年資較淺的同事，並能高效協助主管處理局內各項繁重事務。"}
        ],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "能帶領分隊有效地執行上級委派的工作，照顧隊員安全。", "局內": "能協助主管處理各項事務，分析隊員長劣並調派得妥，令工作更有效率。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "能帶領分隊執行工作，照顧小隊安全。", "局內": "能夠帶領局內各類型的基本操練。"}]
    },
    # ---------------- 為了縮短代碼長度，第6-16項暫時保留單一款式設計，你可以隨時按上面格式自行增加寫法二、寫法三 ----------------
    "6. 服從紀律": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "聽從上級指令，非常迅速有效地執行各項任務。嚴格遵從部門訓令，並能適時提醒其他隊員遵從。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "聽從上級指令，正確執行各項任務，遵從各項部門訓令。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "聽從指令執行任務並遵從規例。"}]
    },
    "7. 幹勁與決心": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "能為自己及其他隊員訂立各種目標及落實執行時間，追求卓越，非常積極學習新的消防知識以充實自己。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "能為自己訂立目標，願意學習新的消防知識。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "能為自己訂立目標及接受新知識。"}]
    },
    "8. 面對壓力的表現": {
        "優 (A)": [{"desc": "寫法一 (標準)", "行動": "於任何惡劣環境下仍能細心聽從上級指令並迅速完成，能冷靜處理突發事故，清楚滙報現場狀況。", "局內": "面對群眾時能清楚自信地作工具介紹或防火講座；在模擬事故中能十分迅速有效地處理突發情況。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "於惡劣環境下仍能聽從指令並有效地完成，能處理各項突發事故。", "局內": "面對群眾時能作各種工具介紹；在模擬事故中能冷靜處理突發情況。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "於惡劣環境下能聽從指令並完成任務。", "局內": "面對群眾時能作簡單的工具介紹及防火講座。"}]
    },
    "9. 積極主動": {
        "優 (A)": [{"desc": "寫法一 (標準)", "行動": "經常主動向主管提出確切可行的建議，主動協助其他同事完成職務，並起到協調各單位的角色。", "局內": "經常主動向年青隊員教授消防工具的使用，察覺問題會立刻跟進，並主動對局內事情提出建設性改善建議。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "能向主管提出確切可行的建議，主動接受並妥善完成委派任務。", "局內": "主動向年青隊員教授使用消防工具，察覺問題會立刻要求跟進並時常巡查局內地方。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "接受上級委派的任務並能完成。", "局內": "被請教時願意教授年青隊員使用工具。"}]
    },
    "10. 分析能力": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "能敏銳監察並留意行動中潛在的各種風險，向上級建議解決方法；亦能準確分析各隊員的長劣並加以發揮。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "能監察並留意行動中潛在的各種風險，並滙報予上級。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "偶而能監察並留意行動中潛在的風險並滙報。"}]
    },
    "11. 判斷能力": {
        "優 (A)": [{"desc": "寫法一 (標準)", "行動": "處理救援工作時能根據緩急輕重，非常迅速判斷出先後次序，並於變化環境中審時度勢作出相應調整。", "局內": "處理局內工作時能準確無誤地判斷出處理的先後次序。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "能根據事情緩急輕重判斷處理次序，於變化環境中在上級領導下作出調整。", "局內": "能根據事情緩急輕重判斷局內工作的先後次序。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "能判斷出處理先後次序。", "局內": "能判斷出局內工作的處理次序。"}]
    },
    "12. 組織能力": {
        "優 (A)": [{"desc": "寫法一 (標準)", "行動": "能因應現場策略目標，靈活有系統地調派各小分隊工作。", "局內": "能有條理地管理各種局內事宜，紀錄清晰，並不斷提出改善建議。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "能因應任務目標，靈活有系統地調派自己分隊工作。", "局內": "能有條理地管理局內事宜及紀錄清晰。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "能協助自己分隊完成工作。", "局內": "能管理局內事宜，紀錄清楚。"}]
    },
    "13. 溝通能力": {
        "優 (A)": [{"desc": "寫法一 (標準)", "行動": "使用無線電時能非常清晰簡潔地傳達信息。", "局內": "在防火講座及面對參觀人士時講解極之清晰、生動有趣及自信。在會議中清楚表達意見，並能用文字精準記錄運作過程。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "行動": "使用無線電時能十分清晰簡潔地傳達信息。", "局內": "面對參觀人士時講解清晰及信心十足，介紹工具時條理分明。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "行動": "能清晰地傳達無線電信息。", "局內": "面對到訪人士時能簡單介紹局內運作。"}]
    },
    "14. 儀容和舉止": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "經常保持極良好的儀容和舉止。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "經常保持良好的儀容和舉止。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "儀容和舉止恰當。"}]
    },
    "15. 與人相處的技巧": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "擁有極佳與人相處的技巧，平易近人，能與同事建立深厚互信，在局內營造出和諧氣氛。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "與人相處融洽，能與同事建立良好關係。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "能與同事和睦相處。"}]
    },
    "16. 支持/參加部門活動": {
        "優 (A)": [{"desc": "寫法一 (標準)", "通用": "非常積極參與及支持部門活動，並協助上級籌備。"}],
        "良 (B)": [{"desc": "寫法一 (標準)", "通用": "積極參與並支持部門活動。"}],
        "常/當 (C)": [{"desc": "寫法一 (標準)", "通用": "積極支持部門活動，如到場打氣等。"}]
    }
}

# ==========================================
# 介面設置
# ==========================================
st.set_page_config(page_title="消防考績系統", layout="wide")
st.title("🚒 消防人員考績系統 (FS-278)")

tab1, tab2, tab3 = st.tabs(["📝 考績生成器 (Generator)", "📚 舊料資料庫 (Database)", "🖍️ Highlighter (評分標記)"])

# ==========================================
# TAB 1: 考績生成器
# ==========================================
with tab1:
    st.info("請填寫基本資料並選擇各項評級。揀選評級後，可於下方款式選單挑選不同的句子變化。")
    
    col1, col2, col3, col4 = st.columns(4)
    with col1: member_name = st.text_input("人員姓名", "王國良")
    with col2: member_rank = st.selectbox("職級", ["消防隊目", "消防總隊目", "消防員"])
    with col3: overall_rating = st.selectbox("整體評級", ["優 (A)", "良 (B)", "常/當 (C)"])
    with col4: future_plan = st.text_input("未來動向/建議訓練", "參加煙火特攻員訓練課程")

    st.markdown("### 📊 FS-278 評分細項與寫法款式")
    with st.expander("點擊展開/收起 16項評分設定", expanded=True):
        selections = {}
        items_list = list(fs278_db.keys())
        
        # 為了排版整齊，我們每行放兩個項目 (每個項目包含「評級」同「寫法」)
        for i in range(0, len(items_list), 2):
            col_a1, col_a2, col_b1, col_b2 = st.columns(4)
            
            # 處理左邊嘅項目
            item1 = items_list[i]
            with col_a1:
                grade1 = st.selectbox(item1, ["優 (A)", "良 (B)", "常/當 (C)"], key=f"g_{i}")
            with col_a2:
                # 根據揀咗嘅評級，抽返對應嘅寫法 list 出嚟
                variations1 = fs278_db[item1][grade1]
                style_names1 = [v["desc"] for v in variations1]
                selected_style1 = st.selectbox(f"{item1}款式", style_names1, key=f"s_{i}", label_visibility="collapsed")
                # 儲存最終揀中嗰一組 dictionary
                selections[item1] = variations1[style_names1.index(selected_style1)]
            
            # 處理右邊嘅項目 (如果有的話)
            if i + 1 < len(items_list):
                item2 = items_list[i+1]
                with col_b1:
                    grade2 = st.selectbox(item2, ["優 (A)", "良 (B)", "常/當 (C)"], key=f"g_{i+1}")
                with col_b2:
                    variations2 = fs278_db[item2][grade2]
                    style_names2 = [v["desc"] for v in variations2]
                    selected_style2 = st.selectbox(f"{item2}款式", style_names2, key=f"s_{i+1}", label_visibility="collapsed")
                    selections[item2] = variations2[style_names2.index(selected_style2)]

    st.markdown("### 📝 具體事故案例補充")
    specific_case = st.text_area("請簡述一個具體行動案例", "例如於二零二四年四月十日在佐敦道華豐大廈發生的三級火警中，當日作為升降台隊目並以搜救隊身份執行任務。臨危不亂，有條理及清晰地指派各隊員執行任務，最終成功救出被困人士。")
    events_input = st.text_input("近期參與的部門活動", "油尖旺社區應急防火嘉年華2024")

    if st.button("🚀 一鍵生成考績報告", type="primary", use_container_width=True):
        para1_traits = []
        para2_ops = []
        para3_sta = []
        para4_misc = []

        for item_name, content_dict in selections.items():
            if "行動" in content_dict: para2_ops.append(content_dict["行動"])
            if "局內" in content_dict: para3_sta.append(content_dict["局內"])
            if "通用" in content_dict:
                if item_name in ["4. 可靠程度", "6. 服從紀律", "7. 幹勁與決心", "10. 分析能力", "14. 儀容和舉止", "15. 與人相處的技巧"]:
                    para1_traits.append(content_dict["通用"])
                elif item_name == "16. 支持/參加部門活動":
                    para4_misc.append(content_dict["通用"])

        p1_text = f"【個人特質與紀律】\n{member_rank}{member_name}對工作盡忠職守。{'此外，'.join(para1_traits)}"
        p2_text = f"【行動工作表現】\n在行動工作方面，{member_name[0]}{member_rank[-2:]}表現卓越。{''.join(para2_ops)}這點在他處理實際事故時表露無遺。{specific_case}"
        p3_text = f"【局內工作表現】\n在局內工作方面，{member_name[0]}{member_rank[-2:]}極之能幹可靠。{''.join(para3_sta)}"
        p4_text = f"【總結與未來動向】\n{member_name[0]}{member_rank[-2:]}{para4_misc[0] if para4_misc else ''}例如參與{events_input}。整體來說，他在評核期內各方面工作表現令人滿意，故此我把他的表現評為「{overall_rating.split(' ')[0]}」級。在訓練方面，我建議他{future_plan}。"

        final_text = f"{p1_text}\n\n{p2_text}\n\n{p3_text}\n\n{p4_text}"
        st.success("✅ 報告生成成功！")
        st.text_area("📋 複製您的考績報告：", final_text, height=450)

# ==========================================
# (TAB 2 同 TAB 3 嘅代碼維持不變，請確保連埋一齊 copy)
# ==========================================
with tab2:
    st.header("📚 舊料資料庫 (Historical Database)")
    region = st.radio("請選擇總區：", ["🏢 九龍 (Kowloon)", "🏙️ 香港 (Hong Kong)", "🌳 新界南 (NTS)", "⛰️ 新界北 (NTN)"], horizontal=True)
    year_selected = st.selectbox("請選擇年份：", ["2025", "2024", "2023"])
    st.markdown("---")
    if region == "🏢 九龍 (Kowloon)":
        if year_selected == "2025":
            st.subheader("九龍總區 - 2025年 範例 1 (消防隊目 王國良)")
            st.info("消防隊目王國良對工作盡忠職守，極為嚴守紀律。在處事方面，他極有幹勁及決心，亦極願意承擔額外責任。只要是上司委派給他的工作，他也能極有效率地帶領屬員把工作適時妥當地完成，深得局內各同事對他的工作表現的認同。此外，他的儀容及制服時常保持在非常整齊清潔的水平，反映他的自我要求甚高。\n\n行動方面，王隊目實戰經驗極為豐富，對各種消防車輛及拯救工具的使用方法極為熟識，判斷力亦極為出色，能夠在短時間內對火場作出全面的觀察及評估，並運用他極為出色的組織能力為隊員制定行動方向，往往能表現出極佳的領導才能。例如於二零二四年四月十日在佐敦道13-15號號華豐大廈發生的三級火警中，王隊目當日作為升降台隊目並以搜救隊身份執行任務。他被搜救隊主管委派對不同的救助個案作出救援。王隊目臨危不亂，有條理及清晰地指派各隊員執行所委派的任務。最終亦不負所託，成功救出兩名昏迷人士及三名被困人士，其後更獲得處長嘉許狀。除此之外，於二零二四年九月十日九龍窩打老道56號九龍華仁書院發生的特別服務(企跳)中，王隊目當日作為細搶救車主管。在到達現場後，企跳人士已情緒激動，危坐在天台旁。幸得王隊目運用之前從判技巧訓練課程所習得的知識，成功地安撫到企跳人士的情緒，最終成功將他帶到安全位置。從以上事件中，絕對能夠反映出王隊長有著極高抗壓能力，以及領導才能，表現極為可靠。\n\n局內工作方面，隊目王國良除了協助管理局內各形各色的日常行動事務外，還會極為積極協助隊長處理局內行政工作，包括協助編排本隊的當值人手，並能與隊中各級的同事協調，確保有足夠人員當值。此外，他經常留意同事在工作上的需要，並運用他非常出色的分析能力探討各種解決困難的方案。王隊目亦為見習消防員培訓計劃導師，他會以自身及工作經驗對年資較淺的同事分享心得，協助他們加快適應新工作環境和消防生活，盡顯師徒制的理念。王隊目憑著他極佳的溝通能力及與人相處技巧，與所有同事也有著極良好互信關係，相處融洽，深受同事歡迎。他在評核期間被安排署理消防總隊目職位時，都有出色的表現，顯示出他優秀的領導才能及擁有成為總隊目的潛質。王隊目亦非常支持部門活動，例如協助舉辦油尖旺社區應急防火嘉年華2024以及新油麻地避風塘及公眾貨物裝卸區防火宣傳日。此外，王隊目得悉血庫存量不足，亦於休班時參加九龍總區捐血日，以補充血庫存量，反映王隊目心繁社會。\n\n整體來說，王隊目在評核期內各方面工作表現令人滿意，故此我把他的表現評為「優」級。在訓練方面，我建議他參加煙火特攻員訓練課程。對於他希望繼續留在行動總區工作的意願，我對此表示支持。")
            st.subheader("九龍總區 - 2025年 範例 2 (消防隊目 吳國強)")
            st.info("消防隊目吳國強是一個紀律性極強，工作態度十分認真，極具責任感及幹勁的消防人員。他會適時滙報上級委派予他的工作進度，是一名極之可靠的副手。他自我要求嚴謹，經常保持良好的儀容和舉止。另一方面他平易近人與同事融洽相處，在局內能營造出和諧的氣氛。\n\n在行動工作方面，吳隊目擁有極強的分析及抗壓能力，加上他多年豐富的前線救援經驗，對消防知識尤其是救援技巧及突發事故的應變有透徹的認識，在面對複雜多變的事故現場時，他都能冷靜處理，並帶領隊員迅速地完成主管所指派的任務。例如在二零二四年四月十日佐敦道13-15號華豐大廈三級火警中，吳隊目當日作為泵車隊目，與隊員迅速開喉到火警樓層進行滅火及搜救工作。及後，聯同隊員到各樓層搜索及爆破，並確認沒有被困人士，他靈活運用人手傳遞訊息，大大加強了現場的溝通及協調，順利完成滅火及救援工作。\n\n在局內工作方面，吳隊目極之能幹可靠，會協助管理局內各形各色的日常事務，在隊員的操練方面，他亦會主動向主管提出一些操練上的建議，對年資較淺的隊員的滅火及救援訓練要求甚高，每一次的局內操練，都會親力親為，就不同的情況例如高空拯救、一級火警、交通意外有人被困等，都會悉心設計出與真實環境相似的訓練，務求令到隊員透過操練，維持他們對前線工作的敏感度及效率。此外他會聯同其他隊目及總隊目，主動帶領年在前線工作的敏感度及效率。此外他會聯同其他隊目及總隊目，主動帶領年資較淺的隊員，為他們工作上遇到的問題提供意見，協助他們適應本局忙碌及充實的工作環境。\n\n吳隊目亦非常支持部門活動，例如協助舉辦油尖旺社區應急防火嘉年華2024，消防處國家安全展覽廳團體參觀，國慶青年節計劃2024，新油麻地避風塘及公眾貨物裝卸區防火宣傳日以及啟德體育館壓力測試，反映吳隊目心繫社會，盡己所能。")
        else:
            st.warning(f"暫無 {year_selected} 年的九龍總區舊料。")

with tab3:
    st.header("🖍️ FS-278 評分標記 Highlighter")
    st.write("將考績文章貼喺下面，系統會自動捕捉句子中嘅關鍵字，喺底線上面標註返對應嘅 FS-278 項目號碼（1至16）。")
    text_to_highlight = st.text_area("輸入/貼上考績文章：", height=200, placeholder="消防隊目王國良對工作盡忠職守，極為嚴守紀律...")
    highlight_keywords = {
        "1": r"(工作認識|特別風險|緊急應變計劃|消防設施|滅火拯救工具.*熟識|常務訓令|消防事務手冊|行政工作程序|車輛保養|局內維修|消防車輛及拯救工具.*使用方法)",
        "2": r"(行動效率|專業能力|迅速.*完成工作|多方面思考|操練中表現|糾正.*錯誤|可行建議|效率極高)",
        "3": r"(承擔責任|積極接受各類型工作|尋找火源|調查成因|文書處理|倉庫管理|積極承擔|願意承擔額外責任)",
        "4": r"(可靠程度|準確無誤.*完成|定期.*滙報|信賴|可靠的副手|表現極為可靠)",
        "5": r"(領導才能|現場總指揮|分配工作|帶領.*執行任務|照顧.*安全|帶領局內各類型.*操練|帶領屬員.*完成|帶領隊員|指揮若定)",
        "6": r"(服從紀律|聽從上級.*指令|遵從.*訓令|嚴守紀律|紀律性極強|對工作盡忠職守)",
        "7": r"(幹勁與決心|訂立.*目標|追求卓越|學習新.*消防知識|幹勁及決心|極具責任感及幹勁)",
        "8": r"(面對壓力|抗壓能力|惡劣環境.*聽從|冷靜.*處理|突發事故|面對群眾|臨危不亂|安撫.*情緒)",
        "9": r"(積極主動|主動向.*提出|主動協助|主動.*教授|察覺有問題.*跟進|主動帶領)",
        "10": r"(分析能力|潛在.*風險|分析各隊員|觀察及評估|解決困難的方案)",
        "11": r"(判斷能力|判斷力|緩急輕重|先後次序|審時度勢)",
        "12": r"(組織能力|策略目標|有系統地|有條理.*管理|協助管理局內.*事務|編排.*人手|制定行動方向)",
        "13": r"(溝通能力|無線電|防火講座|講解清晰|文字記錄|傳遞訊息|溝通及協調)",
        "14": r"(儀容和舉止|儀容|舉止|制服.*整齊)",
        "15": r"(與人相處|平易近人|融洽相處|和諧.*氣氛|互信關係|相處融洽)",
        "16": r"(部門活動|防火嘉年華|參觀|捐血日|國慶|防火宣傳日)"
    }
    if st.button("🖍️ 開始標記分析", type="primary"):
        if text_to_highlight:
            parts = re.split(r'([。，！？\n；])', text_to_highlight)
            highlighted_output = ""
            for i in range(0, len(parts)-1, 2):
                clause = parts[i]
                punct = parts[i+1]
                matched_item = None
                for item_num, pattern in highlight_keywords.items():
                    if re.search(pattern, clause):
                        matched_item = item_num
                        break
                if matched_item:
                    highlighted_output += f'<ruby><u style="text-decoration-color: #ff4b4b; text-decoration-thickness: 2px; text-underline-offset: 4px;">{clause}</u><rt style="color:#ff4b4b; font-weight:bold; font-size:0.9em; margin-bottom:2px;">{matched_item}</rt></ruby>{punct}'
                else:
                    highlighted_output += clause + punct
            if len(parts) % 2 != 0:
                highlighted_output += parts[-1]
            st.markdown("### 📝 分析結果：")
            st.markdown(f"<div style='line-height: 2.5; font-size: 16px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;'>{highlighted_output}</div>", unsafe_allow_html=True)
            st.info("💡 提示：句子上面嘅紅色數字代表對應嘅 FS-278 項目（例如 1 = 工作認識，6 = 服從紀律）。")
        else:
            st.warning("請先輸入考績文章！")
