import streamlit as st
import pandas as pd
import re

# ==========================================
# 0. 讀取 Google Sheet 雲端資料庫函數
# ==========================================
@st.cache_data(ttl=60)
def load_gsheet():
    sheet_id = "1-wHN-fHSIrziB-KfM1Pck9S8qh8nWqDF-kMERfInoWg"
    csv_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv"
    try:
        df = pd.read_csv(csv_url)
        return df
    except Exception as e:
        return None

# ==========================================
# 1. 建立 FS-278 評分指標資料庫
# ==========================================
fs278_db = {
    "1. 工作認識": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "極之熟悉分區內的各特別風險及其緊急應變計劃，對分局內各樓宇的消防設施及裝置極之熟悉。對所有滅火拯救工具的運用都瞭如指掌，並了解現時極為先進的滅火常識", "局內": "熟讀部門的各項公文，對部門的新發展非常熟悉，並極為精通各項繁瑣的行政與工作程序"},
            {"desc": "寫法二 (強調實戰)", "行動": "實戰經驗極為豐富，對各種消防車輛及拯救工具的使用方法極為熟識，對分局內的特別風險瞭如指掌，展現出極為深厚的專業知識", "局內": "對局內各項公文及新發展瞭如指掌，並能非常精準無誤地處理各項行政與工作程序"},
            {"desc": "寫法三 (理論實踐並重)", "行動": "對傳統消防學術及前線拯救裝備均有極為透徹的認識，極之熟悉分區內所有高危險設施及應變方案", "局內": "對各類消防手冊及常務訓令極為熟悉，非常清晰了解部門未來的發展方向及工作程序"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "十分熟知分局內的各特別風險及其緊急應變計劃，對各樓宇的消防設施有充分了解，對局內各種拯救工具十分熟悉", "局內": "對部門的各項公文有深厚的認識，十分熟悉各項行政工作程序，並密切留意部門的新發展"},
            {"desc": "寫法二 (穩健可靠)", "行動": "具備十分良好的消防常識，對轄區內的樓宇設施及救援工具均有深厚的認識", "局內": "十分熟知部門公文及常務訓令，對局內行政程序處理妥當"},
            {"desc": "寫法三 (經驗豐富)", "行動": "對各類拯救工具及裝備的運用十分熟練，對分區內的緊急應變計劃有深厚了解", "局內": "對各類文件往來及維修保養程序十分熟悉，具備良好的行政知識"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "認識分局內的各特別風險及其緊急應變計劃，對局內各種滅火拯救工具有一定的認識", "局內": "對部門的各項公文有一定的認識，對個別行政程序有基本了解"},
            {"desc": "寫法二 (基本達標)", "行動": "對基本的滅火拯救工具有一定了解，對轄區風險有基本認識", "局內": "對局內一般的行政及工作程序具備基礎認識"}
        ]
    },
    "2. 行動效率/專業能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "在無需監督下，能非常迅速、極有效地完成工作。處事能作多方面思考並常常給予上級多個極具建設性的建議，非常充分顧及團隊及公眾安全", "局內": "在各種操練中表現極為傑出，能即時糾正其他隊員的錯誤，更能提出非常出色的改善建議"},
            {"desc": "寫法二 (思維敏捷)", "行動": "工作效率極高，能在無須監督的情況下非常迅速妥善完成任務。處事靈活，經常為上級提供極佳的行動建議", "局內": "於各項操練中表現卓越，不單能即時指導隊員，更能非常主動構思並建議不同形式的模擬操練"},
            {"desc": "寫法三 (技術精湛)", "行動": "展現出極為出色的專業救援技術，任何指派任務皆能非常迅速且妥當地完成，安全意識極高", "局內": "在日常操練中表現極佳，是隊伍中的技術骨幹，能為局內訓練提供極具價值的意見"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "在無需監督下，能迅速有效地完成工作，經常能給予上級確切可行的建議", "局內": "在各種操練中表現良好，能對基本操練提出改善建議"},
            {"desc": "寫法二 (表現良好)", "行動": "工作效率良好，能妥善完成上級委派的任務，並具有充分的安全意識", "局內": "參與操練時表現十分積極良好，時常能提出可行的意見"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "在有限的監督下，能迅速有效地完成工作，偶而給予上級建議", "局內": "在基本操練中表現良好"},
            {"desc": "寫法二 (按本子辦事)", "行動": "能按指示完成工作，具備基本的安全意識", "局內": "能完成局內各項基本操練"}
        ]
    },
    "3. 承擔責任": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "極之積極接受各類型工作，如主動深入現場尋找火源及調查成因，極具責任心", "局內": "極為積極承擔局內工作，除了將物資及文書管理得井井有條外，更能不斷作出極佳的改善建議"},
            {"desc": "寫法二 (勇於擔當)", "行動": "極願意承擔額外責任，無論面對任何艱巨任務皆極為積極應對，絕不推諉", "局內": "對局內大小事務皆極具責任感，非常積極分擔主管的工作壓力"},
            {"desc": "寫法三 (主動投入)", "行動": "投入感極高，非常主動承攬具挑戰性的拯救任務", "局內": "極度熱心於局內事務，能自動自覺並極為妥善地管理各項繁瑣工作"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "積極接受各類型工作，於上級委派下迅速行動", "局內": "積極承擔局內各項工作並管理得當"},
            {"desc": "寫法二 (盡責妥善)", "行動": "對自身職務十分盡責，願意接受不同的救援任務", "局內": "十分願意協助處理局內文書及倉務，並能妥善完成"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "接受並妥善完成簡單的行動工作", "局內": "在上級委派下承擔局內工作並管理得當"},
            {"desc": "寫法二 (基本責任)", "行動": "能承擔一般的拯救及爆破工作", "局內": "在督導下能完成指派的局內雜務"}
        ]
    },
    "4. 可靠程度": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "多次工作皆能非常準確無誤地在指定時間內完成，並定期作出極清晰的滙報，深得各級同事極大的信賴"},
            {"desc": "寫法二 (絕對信任)", "通用": "是一名極之可靠的副手，凡事皆能極為妥當地完成並適時滙報進度，表現極為可靠"},
            {"desc": "寫法三 (一絲不苟)", "通用": "處事極為嚴謹，任何指派工作皆能非常準確地完成，其可靠的表現深受長官及同袍的高度讚賞"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "每項工作皆能準確無誤地完成，並定期作出滙報，深得上級認同"},
            {"desc": "寫法二 (值得交託)", "通用": "表現十分可靠，交代的工作皆能按時妥善完成，深得信任"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "每項工作皆能完成並定期滙報"},
            {"desc": "寫法二 (基本達標)", "通用": "在有限監督下能順利完成被指派的任務"}
        ]
    },
    "5. 領導才能": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "能夠協助現場總指揮恰當地分配工作，非常有效地調派及帶領各分隊執行任務，並極為全面地照顧隊員安全", "局內": "能夠極出色地帶領局內各類型的操練，即時糾正同事錯誤，並極主動協助分隊主管妥善管理局內大小事務"},
            {"desc": "寫法二 (指揮若定)", "行動": "運用極為出色的組織能力為隊員制定行動方向，往往能表現出極佳的領導才能，於現場指揮若定", "局內": "具備極優秀的領導潛質，經常主動指導年資較淺的同事，極大程度減輕主管的行政負擔"},
            {"desc": "寫法三 (凝聚力強)", "行動": "帶領小隊時極具威信，能非常迅速地凝聚隊員力量以極高效率完成救援", "局內": "在隊中極具說服力，能非常妥善地分析隊員長短處並作出極佳的人手調配"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "能帶領分隊有效地執行上級委派的工作，照顧隊員安全", "局內": "能協助主管處理各項事務，分析隊員長劣並調派得妥，令工作更有效率"},
            {"desc": "寫法二 (良好帶領)", "行動": "具備十分良好的帶隊能力，能妥善分配人手並執行任務", "局內": "能十分有效地帶領局內基本操練，並協助主管處理人事事宜"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "能帶領分隊執行工作，照顧小隊安全", "局內": "能夠帶領局內各類型的基本操練"},
            {"desc": "寫法二 (基本指揮)", "行動": "能提醒分隊隊員注意安全並完成任務", "局內": "在上級協助下能帶領部分局內操練"}
        ]
    },
    "6. 服從紀律": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "極為嚴守紀律，聽從上級指令時非常迅速有效地執行各項任務。極嚴格遵從部門訓令，並能適時提醒其他隊員遵從"},
            {"desc": "寫法二 (絕對服從)", "通用": "紀律性極強，對部門公文及規例極為熟悉且嚴格遵守，執行上司命令時從不猶豫，非常迅速妥當"},
            {"desc": "寫法三 (以身作則)", "通用": "自我要求極高，時刻保持極佳的紀律操守，更是同袍間遵從各項局內訓令的極佳榜樣"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "聽從上級指令，正確執行各項任務，遵從各項部門訓令"},
            {"desc": "寫法二 (紀律良好)", "通用": "具有十分良好的紀律意識，能妥善遵從公務員事務規例及局內指令"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "聽從指令執行任務並遵從規例"},
            {"desc": "寫法二 (基本達標)", "通用": "能遵守一般部門訓令及工作要求"}
        ]
    },
    "7. 幹勁與決心": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "極有幹勁及決心，能為自己及團隊訂立極具挑戰性的目標。追求卓越，非常積極學習新的消防知識以充實自己"},
            {"desc": "寫法二 (力求進步)", "通用": "對消防工作抱有極大的熱誠，展現出極強的進取心，非常熱衷於參與各類新式訓練以提升專業水平"},
            {"desc": "寫法三 (堅毅不屈)", "通用": "處事極具決心，面對困難絕不輕言放棄，並極為積極地吸收新知識，自我要求極高"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "能為自己訂立目標，願意學習新的消防知識"},
            {"desc": "寫法二 (表現積極)", "通用": "具備十分良好的幹勁，時常參與講座及訓練以充實自己"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "能為自己訂立目標及接受新知識"},
            {"desc": "寫法二 (基本達標)", "通用": "在工作上具有一定的幹勁"}
        ]
    },
    "8. 面對壓力的表現": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "有着極高的抗壓能力，於任何惡劣環境下仍能非常冷靜地聽從指令並極迅速完成任務，清楚滙報現場狀況", "局內": "面對群眾時能非常清楚自信地作工具介紹；在模擬事故中能極之迅速有效地處理突發情況"},
            {"desc": "寫法二 (臨危不亂)", "行動": "心理質素極佳，在複雜多變且極具壓力的事故現場中臨危不亂，能非常冷靜處理各種突發事故", "局內": "面對大型群眾或突發考驗時表現極為鎮定，展現出極佳的自信心"},
            {"desc": "寫法三 (泰然自若)", "行動": "面對極端惡劣的火場環境亦毫無懼色，極為冷靜地評估風險並非常有效地執行救援任務", "局內": "在各項高壓的評核及模擬演練中皆表現得極為從容不迫"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "於惡劣環境下仍能聽從指令並有效地完成，能處理各項突發事故", "局內": "面對群眾時能作各種工具介紹；在模擬事故中能冷靜處理突發情況"},
            {"desc": "寫法二 (抗壓良好)", "行動": "抗壓能力十分良好，在緊張環境下仍能冷靜完成上司委派的工作", "局內": "面對群眾時表現十分鎮定，能順利完成講解"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "於惡劣環境下能聽從指令並完成任務", "局內": "面對群眾時能作簡單的工具介紹及防火講座"},
            {"desc": "寫法二 (基本達標)", "行動": "在上級帶領下能應付一般的突發事故壓力", "局內": "面對少量群眾時能作基本介紹"}
        ]
    },
    "9. 積極主動": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "極為主動，經常向主管提出極為確切可行的建議。非常主動協助其他同事完成職務，並起到極佳的協調角色", "局內": "極為熱心向年青隊員教授消防知識，察覺問題會立刻主動跟進，並對局內事情提出極具建設性的建議"},
            {"desc": "寫法二 (先知先覺)", "行動": "行動時極具前瞻性，經常主動洞察先機並向長官提供極佳的戰略建議，大大提升行動效率", "局內": "經常極度主動巡查局內設施，防患於未然，更是極樂意提攜後輩的良師"},
            {"desc": "寫法三 (全情投入)", "行動": "極為主動承攬各種艱難任務，經常自動請纓協助同袍，團隊精神極佳", "局內": "對局內大小事務皆極為主動關心，經常提出極具實際效益的改善方案"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "能向主管提出確切可行的建議，主動接受並妥善完成委派任務", "局內": "主動向年青隊員教授使用消防工具，察覺問題會立刻要求跟進並時常巡查局內地方"},
            {"desc": "寫法二 (主動性強)", "行動": "十分主動協助同袍，經常提出十分可行的行動建議", "局內": "願意主動教導資淺同事，對局內問題會主動滙報"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "接受上級委派的任務並能完成", "局內": "被請教時願意教授年青隊員使用工具"},
            {"desc": "寫法二 (基本達標)", "行動": "很少向主管提出建議，但能完成份內工作", "局內": "偶而會巡查局內地方及發現問題"}
        ]
    },
    "10. 分析能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "分析能力極為出色，能極敏銳地監察並留意行動中潛在的各種風險並建議極佳的解決方法；亦能極準確分析各隊員的長劣"},
            {"desc": "寫法二 (洞察秋毫)", "通用": "具備極強的邏輯分析及洞察力，能極迅速地探討各種解決困難的方案，確保行動萬無一失"},
            {"desc": "寫法三 (知人善任)", "通用": "能極為精準地分析各隊員的能力並加以最大化發揮，對現場潛在危機的分析更是極之透徹"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "能監察並留意行動中潛在的各種風險，並滙報予上級"},
            {"desc": "寫法二 (分析良好)", "通用": "具備十分良好的分析能力，能妥善留意四周風險"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "偶而能監察並留意行動中潛在的風險並滙報"},
            {"desc": "寫法二 (基本達標)", "通用": "具備基本的現場觀察及分析能力"}
        ]
    },
    "11. 判斷能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "判斷力極為出色，能根據緩急輕重極迅速判斷出救援先後次序，並於瞬息萬變的環境中審時度勢作出極佳調整", "局內": "處理局內工作時能極為準確無誤地判斷出處理的先後次序"},
            {"desc": "寫法二 (果斷精準)", "行動": "在短時間內能對火場作出極為全面的評估，判斷極之果斷精準，絕不拖泥帶水", "局內": "對局內繁雜事務的輕重緩急有極其準確的判斷，處事極有條理"},
            {"desc": "寫法三 (應變自如)", "行動": "面對突發變化時，能極之迅速地作出相應的戰術調整，判斷能力極高", "局內": "能極精準地決定行政工作的優先次序，效率極高"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "能根據事情緩急輕重判斷處理次序，於變化環境中在上級領導下作出調整", "局內": "能根據事情緩急輕重判斷局內工作的先後次序"},
            {"desc": "寫法二 (判斷良好)", "行動": "具備十分良好的判斷能力，能妥善安排工作的先後次序", "局內": "處理局務時判斷十分準確"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "能判斷出處理先後次序", "局內": "能判斷出局內工作的處理次序"},
            {"desc": "寫法二 (基本達標)", "行動": "在指導下能作出基本的行動判斷", "局內": "能應付一般局內事務的判斷"}
        ]
    },
    "12. 組織能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "擁有極為出色的組織能力，能因應現場策略極靈活有系統地調派分隊工作", "局內": "能極有條理地管理各種局內事宜，紀錄極之清晰，並不斷提出極具價值的改善建議"},
            {"desc": "寫法二 (運籌帷幄)", "行動": "能極為妥善地協調及組織現場人手，確保各項拯救目標得以極高效率完成", "局內": "在策劃局內大型操練或行政安排時，展現出極強的組織心思，井然有序"},
            {"desc": "寫法三 (井井有條)", "行動": "能靈活運用人力資源，極為有系統地制定行動方向", "局內": "將局內大小事務組織得極為完善，各項紀錄一絲不苟，極具條理"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "能因應任務目標，靈活有系統地調派自己分隊工作", "局內": "能有條理地管理局內事宜及紀錄清晰"},
            {"desc": "寫法二 (組織良好)", "行動": "具備十分良好的組織力，能妥善分配自己分隊的工作", "局內": "局內事務管理十分妥當，文件紀錄清晰"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "能協助自己分隊完成工作", "局內": "能管理局內事宜，紀錄清楚"},
            {"desc": "寫法二 (基本達標)", "行動": "能基本組織並完成獲指派的行動任務", "局內": "局內紀錄大致清楚"}
        ]
    },
    "13. 溝通能力": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "行動": "溝通能力極佳，使用無線電時能非常清晰簡潔地傳達信息", "局內": "面對參觀人士時講解極之清晰生動且充滿自信。在會議中能清楚表達極具建設性的意見，文字紀錄極之精準"},
            {"desc": "寫法二 (表達流暢)", "行動": "於嘈雜的火場中仍能極為準確無誤地傳達指令，溝通技巧極為出色", "局內": "擁有極佳的演講技巧，主持防火講座時極具感染力，深得市民讚賞"},
            {"desc": "寫法三 (溝通橋樑)", "行動": "能極有效地與現場各單位協調及傳遞訊息，大大加強了現場的溝通效率", "局內": "文書表達能力極高，能非常清楚流暢地紀錄各項複雜的日常運作"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "行動": "使用無線電時能十分清晰簡潔地傳達信息", "局內": "面對參觀人士時講解清晰及信心十足，介紹工具時條理分明"},
            {"desc": "寫法二 (表達良好)", "行動": "能十分有效地透過無線電與同袍溝通", "局內": "具備十分良好的表達能力，能用文字妥善記錄行動過程"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "行動": "能清晰地傳達無線電信息", "局內": "面對到訪人士時能簡單介紹局內運作"},
            {"desc": "寫法二 (基本達標)", "行動": "能與同事進行基本的無線電溝通", "局內": "能簡單記錄日常運作過程"}
        ]
    },
    "14. 儀容和舉止": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "時常保持極為良好的儀容和舉止，制服非常整齊清潔，反映其自我要求極高"},
            {"desc": "寫法二 (嚴格自律)", "通用": "對自身儀表有極嚴格的要求，時刻保持極佳的紀律部隊形象"},
            {"desc": "寫法三 (榜樣指標)", "通用": "儀容舉止極之端莊得體，堪稱局內同袍的極佳榜樣"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "經常保持良好的儀容和舉止"},
            {"desc": "寫法二 (儀容整潔)", "通用": "制服經常保持十分整潔，舉止十分恰當"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "儀容和舉止恰當"},
            {"desc": "寫法二 (基本達標)", "通用": "服裝儀容符合部門基本規定"}
        ]
    },
    "15. 與人相處的技巧": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "擁有極佳與人相處的技巧，極為平易近人，能與所有同事建立極深厚的互信關係，在局內營造出非常和諧的氣氛"},
            {"desc": "寫法二 (人緣極佳)", "通用": "性格極度友善，相處極為融洽，深受各級同事極大歡迎"},
            {"desc": "寫法三 (極具親和)", "通用": "極具親和力，能非常巧妙地化解人事摩擦，與隊員間的關係極之緊密"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "與人相處融洽，能與同事建立良好關係"},
            {"desc": "寫法二 (關係良好)", "通用": "十分平易近人，與局內同事維持十分良好的工作關係"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "能與同事和睦相處"},
            {"desc": "寫法二 (基本達標)", "通用": "人際關係一般，能融入團隊"}
        ]
    },
    "16. 支持/參加部門活動": {
        "優 (A)": [
            {"desc": "寫法一 (標準全面)", "通用": "非常積極參與及極為支持各項部門活動，並極度主動協助上級籌備，心繫社會"},
            {"desc": "寫法二 (熱心公益)", "通用": "對部門舉辦的對外及內部活動均表現出極大的熱誠，極為積極地投入籌劃工作"},
            {"desc": "寫法三 (全情投入)", "通用": "極為踴躍參加各項社區防火及義工活動，反映其盡己所能的極高情操"}
        ],
        "良 (B)": [
            {"desc": "寫法一 (標準)", "通用": "積極參與並支持部門活動"},
            {"desc": "寫法二 (熱心參與)", "通用": "十分支持部門舉辦的各項體育及推廣活動"}
        ],
        "常/當 (C)": [
            {"desc": "寫法一 (標準)", "通用": "積極支持部門活動，如到場打氣等"},
            {"desc": "寫法二 (基本達標)", "通用": "偶而會出席及支持部門活動"}
        ]
    }
}

# 智能組裝段落函數：自動切換主語，讓文筆更自然
def build_smart_paragraph(sentences, default_subject="他", alt_subjects=None):
    if not sentences:
        return ""
    
    if alt_subjects is None:
        alt_subjects = ["該員", "其"]
        
    connectors = [
        f"{default_subject}",
        f"此外，{default_subject}",
        f"同時，{alt_subjects[0]}",
        f"另一方面，{default_subject}",
        f"再者，{default_subject}",
        f"{alt_subjects[1]}亦"
    ]
    
    result_text = ""
    for i, sentence in enumerate(sentences):
        conn = connectors[i % len(connectors)]
        # 移除句子末尾可能多餘的句號
        clean_sentence = sentence.rstrip("。")
        result_text += f"{conn}{clean_sentence}。"
        
    return result_text

# ==========================================
# 介面設置與 CSS 美化
# ==========================================
st.set_page_config(page_title="消防考績生成系統", layout="wide")

st.markdown("""
    <style>
    .main-title {
        font-size: 32px;
        font-weight: 700;
        color: #1a365d; 
        margin-bottom: 0px;
    }
    .sub-title {
        font-size: 16px;
        color: #555555;
        margin-bottom: 20px;
    }
    /* 隱藏下拉選單的 label 以整齊排版 */
    div[data-testid="stSelectbox"] > label {
        color: #333333;
        font-weight: 600;
        display: none;
    }
    .preview-box {
        font-size: 13px;
        color: #0056b3;
        background-color: #f0f7ff;
        padding: 6px 10px;
        border-radius: 4px;
        margin-top: -12px;
        margin-bottom: 15px;
        border-left: 3px solid #0056b3;
    }
    </style>
""", unsafe_allow_html=True)

st.markdown('<div class="main-title">員佐級人員考績生成系統 (FS-278)</div>', unsafe_allow_html=True)
st.markdown('<div class="sub-title">Hong Kong Fire Services Department - Appraisal System</div>', unsafe_allow_html=True)
st.divider()

tab1, tab2, tab3 = st.tabs(["📄 考績生成系統 (Generator)", "📁 考績檔案庫 (Database)", "🖍️ 評分標記 (Highlighter)"])

# ==========================================
# TAB 1: 考績生成器
# ==========================================
with tab1:
    
    with st.container(border=True):
        st.markdown("**1. 基本資料 (Basic Information)**")
        col1, col2, col3, col4 = st.columns(4)
        with col1: 
            st.markdown("人員姓名")
            member_name = st.text_input("人員姓名", "王國良", label_visibility="collapsed")
        with col2: 
            st.markdown("職級")
            member_rank = st.selectbox("職級", ["消防隊目", "消防總隊目", "消防員", "見習消防員"], label_visibility="collapsed")
        with col3: 
            st.markdown("整體評級")
            overall_rating = st.selectbox("整體評級", ["優 (A)", "良 (B)", "常/當 (C)"], label_visibility="collapsed")
        with col4: 
            st.markdown("未來動向 / 建議訓練")
            future_plan = st.text_input("未來動向 / 建議訓練", "參加煙火特攻員訓練課程", label_visibility="collapsed")

    with st.container(border=True):
        st.markdown("**2. FS-278 評分細項與寫法款式 (Assessment Criteria)**")
        st.caption("請揀選評級，並於其右方下拉選單選擇不同的文字風格，下方會即時顯示句子預覽。")
        
        with st.expander("點擊展開 / 收起 16 項評分設定", expanded=True):
            selections = {}
            items_list = list(fs278_db.keys())
            
            for i in range(0, len(items_list), 2):
                col_a1, col_a2, col_b1, col_b2 = st.columns([1.2, 2.5, 1.2, 2.5])
                
                # 第一個欄位
                item1 = items_list[i]
                with col_a1:
                    st.markdown(f"**{item1}**")
                    grade1 = st.selectbox(item1, ["優 (A)", "良 (B)", "常/當 (C)"], key=f"g_{i}", label_visibility="collapsed")
                with col_a2:
                    st.markdown("**款式選擇**")
                    variations1 = fs278_db[item1][grade1]
                    selected_idx1 = st.selectbox(
                        f"{item1}款式", 
                        options=range(len(variations1)), 
                        format_func=lambda x: f"{variations1[x]['desc']}",
                        key=f"s_{i}", 
                        label_visibility="collapsed"
                    )
                    selections[item1] = variations1[selected_idx1]
                    preview1 = variations1[selected_idx1].get('通用', variations1[selected_idx1].get('行動', ''))
                    st.markdown(f"<div class='preview-box'>📝 他{preview1}。</div>", unsafe_allow_html=True)
                
                # 第二個欄位
                if i + 1 < len(items_list):
                    item2 = items_list[i+1]
                    with col_b1:
                        st.markdown(f"**{item2}**")
                        grade2 = st.selectbox(item2, ["優 (A)", "良 (B)", "常/當 (C)"], key=f"g_{i+1}", label_visibility="collapsed")
                    with col_b2:
                        st.markdown("**款式選擇**")
                        variations2 = fs278_db[item2][grade2]
                        selected_idx2 = st.selectbox(
                            f"{item2}款式", 
                            options=range(len(variations2)), 
                            format_func=lambda x: f"{variations2[x]['desc']}",
                            key=f"s_{i+1}", 
                            label_visibility="collapsed"
                        )
                        selections[item2] = variations2[selected_idx2]
                        preview2 = variations2[selected_idx2].get('通用', variations2[selected_idx2].get('行動', ''))
                        st.markdown(f"<div class='preview-box'>📝 他{preview2}。</div>", unsafe_allow_html=True)

    with st.container(border=True):
        st.markdown("**3. 具體案例與補充資料 (Supplementary Information)**")
        st.markdown("具體行動案例 (將插入至「行動表現」末段)：")
        specific_case = st.text_area("具體行動案例", "例如於二零二四年四月十日在佐敦道華豐大廈發生的三級火警中，當日作為升降台隊目並以搜救隊身份執行任務。臨危不亂，有條理及清晰地指派各隊員執行任務，最終成功救出被困人士。", label_visibility="collapsed")
        st.markdown("近期參與的部門活動 (將插入至「總結」段落)：")
        events_input = st.text_input("近期參與的部門活動", "油尖旺社區應急防火嘉年華2024", label_visibility="collapsed")

    st.write("") 

    if st.button("生成正式考績報告 (Generate Report)", type="primary", use_container_width=True):
        para1_traits = []
        para2_ops = []
        para3_sta = []
        para4_misc = []

        for item_name, content_dict in selections.items():
            if "行動" in content_dict: para2_ops.append(content_dict["行動"])
            if "局內" in content_dict: para3_sta.append(content_dict["局內"])
            if "通用" in content_dict:
                if item_name in ["4. 可靠程度", "6. 服從紀律", "7. 幹勁與決心", "10. 分析能力", "14. 儀容和舉止", "15. 與人相處的技巧"]:
                    para1_traits.append(content_dict["通用"])
                elif item_name == "16. 支持/參加部門活動":
                    para4_misc.append(content_dict["通用"])

        # 根據職級動態決定主語
        subject = f"{member_name[0]}{member_rank[-2:]}" if member_rank != "消防員" and member_rank != "見習消防員" else f"{member_name[0]}隊員"
        alt_subjects = ["該員", "其"]
        
        t1_text = build_smart_paragraph(para1_traits, "他", alt_subjects)
        t2_text = build_smart_paragraph(para2_ops, "他", alt_subjects)
        t3_text = build_smart_paragraph(para3_sta, "他", alt_subjects)
        t4_text = build_smart_paragraph(para4_misc, "他", alt_subjects)

        p1_text = f"【個人特質與紀律】\n{member_rank}{member_name}對工作盡忠職守。{t1_text}"
        p2_text = f"【行動工作表現】\n在行動工作方面，{subject}表現卓越。{t2_text}這點在{subject}處理實際事故時表露無遺。{specific_case}"
        p3_text = f"【局內工作表現】\n在局內工作方面，{subject}極之能幹可靠。{t3_text}"
        
        misc_str = f"{t4_text}例如參與{events_input}。" if events_input else t4_text
        p4_text = f"【總結與未來動向】\n{misc_str}整體來說，該員在評核期內各方面工作表現令人滿意，故此我把他的表現評為「{overall_rating.split(' ')[0]}」級。在訓練方面，我建議他{future_plan}。"

        final_text = f"{p1_text}\n\n{p2_text}\n\n{p3_text}\n\n{p4_text}"
        
        st.divider()
        st.success("系統提示：報告已成功生成。請核對下方內容並複製。")
        st.text_area("📋 考績報告預覽 (Report Preview)：", final_text, height=450)

# ==========================================
# TAB 2: 舊料資料庫 (雲端 Google Sheet 同步版)
# ==========================================
with tab2:
    st.markdown("### 考績檔案庫 (Cloud Database)")
    st.caption("透過 Google Sheet 即時同步的歷年優秀考績撰寫範例。")
    
    df = load_gsheet()
    
    if df is None:
        st.error("⚠️ 系統無法連接至 Google Sheet 資料庫，請檢查分享權限設定。")
    else:
        expected_cols = ["總區", "年份", "職級", "標題", "考績文章"]
        if not all(col in df.columns for col in expected_cols):
            st.warning("📊 資料庫格式有誤：請確保 A 至 E 欄位名稱為「總區」、「年份」、「職級」、「標題」、「考績文章」。")
        else:
            with st.container(border=True):
                st.markdown("**檔案篩選**")
                region_ui = st.radio("篩選總區：", ["九龍總區", "香港總區", "新界南總區", "新界北總區"], horizontal=True)
                region_key = region_ui.replace("總區", "") 
                
                col_y, col_r = st.columns(2)
                with col_y:
                    st.markdown("年份")
                    years_in_sheet = df["年份"].dropna().astype(str).unique().tolist()
                    years = sorted(years_in_sheet, reverse=True) if years_in_sheet else ["2025", "2024", "2023"]
                    year_selected = st.selectbox("篩選年份：", years, label_visibility="collapsed")
                
                with col_r:
                    st.markdown("職級")
                    ranks = ["見習消防員", "消防員", "消防隊目", "消防總隊目"]
                    rank_selected = st.selectbox("篩選職級：", ranks, index=2, label_visibility="collapsed")
                
            st.write("")
            
            filtered_df = df[
                (df["總區"].astype(str).str.contains(region_key, na=False)) & 
                (df["年份"].astype(str) == str(year_selected)) & 
                (df["職級"].astype(str) == str(rank_selected))
            ]
            
            if filtered_df.empty:
                st.info(f"💡 查無記錄：系統目前沒有 {year_selected} 年度 {region_key}總區【{rank_selected}】的檔案。")
            else:
                for idx, row in filtered_df.iterrows():
                    with st.expander(f"📄 檔案標題：{row['標題']} ({row['年份']})", expanded=False):
                        st.write(row['考績文章'])

# ==========================================
# TAB 3: Highlighter
# ==========================================
with tab3:
    st.markdown("### FS-278 評分標記系統 (Highlighter)")
    st.caption("將文本貼上，系統會自動辨識並標註對應的 FS-278 指標編號 (1-16)。")
    
    st.markdown("請於下方輸入考績報告文本：")
    text_to_highlight = st.text_area("考績報告文本", height=200, placeholder="消防隊目王國良對工作盡忠職守，極為嚴守紀律...", label_visibility="collapsed")
    
    highlight_keywords = {
        "1": r"(工作認識|特別風險|緊急應變計劃|消防設施|滅火拯救工具.*熟識|常務訓令|消防事務手冊|行政工作程序|車輛保養|局內維修|消防車輛及拯救工具.*使用方法)",
        "2": r"(行動效率|專業能力|迅速.*完成工作|多方面思考|操練中表現|糾正.*錯誤|可行建議|效率極高)",
        "3": r"(承擔責任|積極接受各類型工作|尋找火源|調查成因|文書處理|倉庫管理|積極承擔|願意承擔額外責任)",
        "4": r"(可靠程度|準確無誤.*完成|定期.*滙報|信賴|可靠的副手|表現極為可靠)",
        "5": r"(領導才能|現場總指揮|分配工作|帶領.*執行任務|照顧.*安全|帶領局內各類型.*操練|帶領屬員.*完成|帶領隊員|指揮若定)",
        "6": r"(服從紀律|聽從上級.*指令|遵從.*訓令|嚴守紀律|紀律性極強|對工作盡忠職守)",
        "7": r"(幹勁與決心|訂立.*目標|追求卓越|學習新.*消防知識|幹勁及決心|極具責任感及幹勁)",
        "8": r"(面對壓力|抗壓能力|惡劣環境.*聽從|冷靜.*處理|突發事故|面對群眾|臨危不亂|安撫.*情緒)",
        "9": r"(積極主動|主動向.*提出|主動協助|主動.*教授|察覺有問題.*跟進|主動帶領)",
        "10": r"(分析能力|潛在.*風險|分析各隊員|觀察及評估|解決困難的方案)",
        "11": r"(判斷能力|判斷力|緩急輕重|先後次序|審時度勢)",
        "12": r"(組織能力|策略目標|有系統地|有條理.*管理|協助管理局內.*事務|編排.*人手|制定行動方向)",
        "13": r"(溝通能力|無線電|防火講座|講解清晰|文字記錄|傳遞訊息|溝通及協調)",
        "14": r"(儀容和舉止|儀容|舉止|制服.*整齊)",
        "15": r"(與人相處|平易近人|融洽相處|和諧.*氣氛|互信關係|相處融洽)",
        "16": r"(部門活動|防火嘉年華|參觀|捐血日|國慶|防火宣傳日)"
    }
    
    if st.button("開始標記分析 (Analyze Text)", type="primary"):
        if text_to_highlight:
            parts = re.split(r'([。，！？\n；])', text_to_highlight)
            highlighted_output = ""
            for i in range(0, len(parts)-1, 2):
                clause = parts[i]
                punct = parts[i+1]
                matched_item = None
                for item_num, pattern in highlight_keywords.items():
                    if re.search(pattern, clause):
                        matched_item = item_num
                        break
                if matched_item:
                    highlighted_output += f'<ruby><u style="text-decoration-color: #ff4b4b; text-decoration-thickness: 2px; text-underline-offset: 4px;">{clause}</u><rt style="color:#ff4b4b; font-weight:bold; font-size:0.9em; margin-bottom:2px;">{matched_item}</rt></ruby>{punct}'
                else:
                    highlighted_output += clause + punct
            
            if len(parts) % 2 != 0:
                highlighted_output += parts[-1]
                
            with st.container(border=True):
                st.markdown("**📝 分析結果 (Analysis Result)：**")
                st.markdown(f"<div style='line-height: 2.5; font-size: 16px; padding: 15px; border-radius: 5px; background-color: #f7fafc;'>{highlighted_output}</div>", unsafe_allow_html=True)
                st.caption("提示：紅線及數字代表對應的 FS-278 指標。")
        else:
            st.warning("請先輸入文本方可進行分析。")
